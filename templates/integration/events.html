{% extends "base.html" %}

{% block title %}Integration Events - Ready Mix Company ERP{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-link"></i> ERP & Job Kart Integration</h2>
        <p class="text-muted">Monitor integration events and system synchronization</p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>Integration Actions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Automatic Processes</h6>
                        <button class="btn btn-primary me-2 mb-2" onclick="autoCreateJobs()">
                            <i class="fas fa-plus"></i> Auto Create Job Cards
                        </button>
                        <button class="btn btn-success me-2 mb-2" onclick="syncInventory()">
                            <i class="fas fa-sync"></i> Sync Inventory
                        </button>
                        <button class="btn btn-info me-2 mb-2" onclick="updateOrderStatus()">
                            <i class="fas fa-refresh"></i> Update Order Status
                        </button>
                    </div>
                    <div class="col-md-6">
                        <h6>Manual Triggers</h6>
                        <button class="btn btn-warning me-2 mb-2" onclick="generateReports()">
                            <i class="fas fa-chart-bar"></i> Generate Reports
                        </button>
                        <button class="btn btn-secondary me-2 mb-2" onclick="validateData()">
                            <i class="fas fa-check-circle"></i> Validate Data
                        </button>
                        <button class="btn btn-danger me-2 mb-2" onclick="resyncAll()">
                            <i class="fas fa-redo"></i> Full Resync
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>Recent Integration Events</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Event ID</th>
                                <th>Event Type</th>
                                <th>Related Order</th>
                                <th>Customer</th>
                                <th>Job Card</th>
                                <th>Job Type</th>
                                <th>Event Time</th>
                                <th>Details</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for event in events %}
                            <tr>
                                <td>{{ event.EventID }}</td>
                                <td>
                                    <span class="badge bg-{% if event.EventType == 'OrderCreated' %}info{% elif event.EventType == 'AutoJobCreation' %}success{% elif event.EventType == 'InventorySync' %}warning{% else %}secondary{% endif %}">
                                        {{ event.EventType }}
                                    </span>
                                </td>
                                <td>
                                    {% if event.OrderID %}
                                        <a href="#" class="badge bg-primary text-decoration-none">
                                            Order #{{ event.OrderID }}
                                        </a>
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>{{ event.CustomerName or 'N/A' }}</td>
                                <td>
                                    {% if event.JobCardID %}
                                        <a href="{{ url_for('jobkart_job_detail', job_id=event.JobCardID) }}" class="badge bg-success text-decoration-none">
                                            Job #{{ event.JobCardID }}
                                        </a>
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>{{ event.JobType or 'N/A' }}</td>
                                <td>{{ event.EventTime }}</td>
                                <td>{{ event.Details[:50] }}{% if event.Details and event.Details|length > 50 %}...{% endif %}</td>
                                <td>
                                    <span class="badge bg-success">
                                        <i class="fas fa-check"></i> Completed
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                            {% if not events %}
                            <tr>
                                <td colspan="9" class="text-center text-muted">No integration events found</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>Integration Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="bg-primary text-white p-3 rounded">
                            <h4>{{ events|length }}</h4>
                            <p>Total Events</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="bg-success text-white p-3 rounded">
                            <h4>{{ events|selectattr('EventType', 'equalto', 'AutoJobCreation')|list|length }}</h4>
                            <p>Auto Job Creations</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="bg-warning text-white p-3 rounded">
                            <h4>{{ events|selectattr('EventType', 'equalto', 'InventorySync')|list|length }}</h4>
                            <p>Inventory Syncs</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="bg-info text-white p-3 rounded">
                            <h4>{{ events|selectattr('EventType', 'equalto', 'OrderCreated')|list|length }}</h4>
                            <p>Order Events</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function autoCreateJobs() {
    if (confirm('This will automatically create job cards for all confirmed orders without existing job cards. Continue?')) {
        fetch('/api/auto_create_jobs', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`${data.created_jobs} job cards created successfully!`);
                location.reload();
            } else {
                alert('Failed to create job cards');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred');
        });
    }
}

function syncInventory() {
    if (confirm('This will sync inventory levels based on completed jobs. Continue?')) {
        fetch('/api/sync_inventory', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`${data.synced_jobs} inventory records synchronized!`);
                location.reload();
            } else {
                alert('Failed to sync inventory');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred');
        });
    }
}

function updateOrderStatus() {
    alert('Order status update integration - Feature coming soon!');
}

function generateReports() {
    alert('Report generation integration - Feature coming soon!');
}

function validateData() {
    alert('Data validation integration - Feature coming soon!');
}

function resyncAll() {
    if (confirm('This will perform a complete resynchronization of all data. This may take time. Continue?')) {
        alert('Full resync integration - Feature coming soon!');
    }
}
</script>
{% endblock %}