{% extends "base.html" %}

{% block title %}Dashboard - Ready Mix Company ERP{% endblock %}

{% block content %}
<style>
    body {
        background:
            linear-gradient(160deg, #e3f0ff 0%, #eaf6f9 100%),
            url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cg fill='%23dce4f2' fill-opacity='0.4'%3E%3Crect x='0' y='0' width='100' height='1'/%3E%3Crect x='0' y='0' width='1' height='100'/%3E%3C/g%3E%3C/svg%3E");
        min-height: 100vh;
    }

    .main-header {
        background: linear-gradient(100deg, #0d6efd 0%, #07b4f6 80%, #60e1e0 100%);
        color: #fff;
        padding: 2.7rem 2.5rem;
        border-radius: 1.3rem;
        margin-bottom: 2.5rem;
        box-shadow: 0 12px 28px rgba(13,110,253,0.14), 0 0.5px 4px 1px #60e1e0;
        position: relative;
        overflow: hidden;
    }
    .main-header::before {
        content: '';
        position: absolute;
        top: 0; right: 0; bottom: 0; left: 0;
        background: radial-gradient(circle at 70% 20%, rgba(255,255,255,0.13) 0%, rgba(0,0,0,0) 70%);
        z-index: 0;
        pointer-events: none;
    }
    .main-header h2 {
        font-weight: 900;
        text-shadow: 0 3px 12px rgba(0,0,0,0.09);
        margin-bottom: 0.25rem;
        letter-spacing: 0.02em;
        position: relative;
        z-index: 1;
    }
    .main-header p {
        opacity: 0.98;
        position: relative;
        z-index: 1;
        font-size: 1.13rem;
    }

    .stats-card {
        background: rgba(255,255,255,0.75);
        border-left: 7px solid;
        border-radius: 1.13rem;
        transition: box-shadow 0.3s, transform 0.35s;
        box-shadow: 0 8px 32px 0 rgba(76, 110, 255, 0.12), 0 1px 8px #0dcaf0;
        overflow: hidden;
        position: relative;
        backdrop-filter: blur(6.5px);
    }
    .stats-card:hover {
        transform: translateY(-8px) scale(1.025);
        box-shadow: 0 16px 28px 0 rgba(13, 110, 253, 0.17), 0 1px 12px #0dcaf0;
    }
    .stats-card .card-body {
        padding: 1.67rem;
        position: relative;
        z-index: 2;
    }
    .stats-card h5 {
        font-size: 1.07rem;
        font-weight: 700;
        color: #5382d7;
        margin-bottom: 0.42rem;
        letter-spacing: 0.02em;
    }
    .stats-card p {
        font-size: 2.32rem;
        font-weight: 800;
        margin-bottom: 0;
        letter-spacing: 0.01em;
    }
    .stats-card .icon {
        position: absolute;
        top: 53%;
        right: 1.5rem;
        font-size: 4.23rem;
        opacity: 0.18;
        pointer-events: none;
        transition: transform 0.3s;
    }
    .stats-card:hover .icon {
        transform: scale(1.15) rotate(-4deg);
    }
    .border-info-left { border-left-color: #36aac1; }
    .border-warning-left { border-left-color: #fdb346; }
    .border-primary-left { border-left-color: #4376f7; }
    .border-success-left { border-left-color: #5ec07e; }
    .border-secondary-left { border-left-color: #8899ad; }
    .border-danger-left { border-left-color: #f66477; }

    .text-info-dark { color: #13b5de; }
    .text-warning-dark { color: #fab037; }
    .text-primary-dark { color: #327ed9; }
    .text-success-dark { color: #13bb81; }
    .text-secondary-dark { color: #6b7b8e; }
    .text-danger-dark { color: #dc4076; }

    .row.g-4 > .col-lg-2 {
        min-width: 240px;
    }

    .card-table .card-header {
        background: linear-gradient(90deg,#e3f0ff 0%, #e8eafc 100%);
        border-bottom: 2px solid #f4f7fd;
        font-weight: 700;
    }
    .card-table .nav-tabs .nav-link.active {
        background: #e8eafc;
        border-bottom-color: #60e1e0;
        color: #327ed9;
        font-weight: 700;
        box-shadow: 0 3px 8px rgba(76,110,255,.07);
    }
    .card-table .nav-tabs .nav-link {
        color: #929fb0;
        transition: background 0.3s, color 0.3s;
    }

    .card.mb-4 {
        border: none;
        box-shadow: 0 4px 16px rgba(253,179,70,0.10), 0 1px 3px #dc3645;
        background: linear-gradient(140deg, #ffc107 45%, #dc3545 95%);
    }
    .card.mb-4 h5 {
        text-shadow: 0 1.5px 2px rgba(0,0,0,0.18);
    }
    .card .btn-lg {
        font-size: 1.1rem;
        font-weight: 700;
        border-radius: 0.85rem;
        box-shadow: 0 2px 10px rgba(13,110,253,0.10);
        padding: 0.95rem 1rem;
    }
    table.table th, table.table td {
        vertical-align: middle;
    }
    .badge {
        font-size: 0.97rem;
        font-weight: 700;
        letter-spacing: 0.04em;
        padding: 0.45em 1.1em;
        border-radius: 0.6em;
        box-shadow: 0 1px 4px rgba(13,110,253,0.08);
    }
</style>

<!-- Header -->
<div class="main-header">
    <h2><i class="fas fa-tachometer-alt me-2"></i> Dashboard Overview</h2>
    <p class="lead mb-0">Welcome back! Here's a real-time summary of your operations.</p>
</div>

<!-- Statistics Cards -->
<div class="row g-4 mb-4">
    <div class="col-lg-2 col-md-4 col-sm-6">
        <div class="card stats-card border-info-left">
            <div class="card-body">
                <h5>Total Orders</h5>
                <p class="text-info-dark">{{ stats.total_orders }}</p>
                <div class="icon text-info-dark"><i class="fas fa-box-open"></i></div>
            </div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6">
        <div class="card stats-card border-warning-left">
            <div class="card-body">
                <h5>Pending Orders</h5>
                <p class="text-warning-dark">{{ stats.pending_orders }}</p>
                <div class="icon text-warning-dark"><i class="fas fa-clock"></i></div>
            </div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6">
        <div class="card stats-card border-primary-left">
            <div class="card-body">
                <h5>Active Jobs</h5>
                <p class="text-primary-dark">{{ stats.active_jobs }}</p>
                <div class="icon text-primary-dark"><i class="fas fa-tasks"></i></div>
            </div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6">
        <div class="card stats-card border-success-left">
            <div class="card-body">
                <h5>Vehicles Free</h5>
                <p class="text-success-dark">{{ stats.available_vehicles }}</p>
                <div class="icon text-success-dark"><i class="fas fa-truck"></i></div>
            </div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6">
        <div class="card stats-card border-secondary-left">
            <div class="card-body">
                <h5>Total Fleet</h5>
                <p class="text-secondary-dark">{{ stats.total_vehicles }}</p>
                <div class="icon text-secondary-dark"><i class="fas fa-truck-pickup"></i></div>
            </div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6">
        <div class="card stats-card border-danger-left">
            <div class="card-body">
                <h5>Low Stock</h5>
                <p class="text-danger-dark">{{ stats.low_inventory }}</p>
                <div class="icon text-danger-dark"><i class="fas fa-exclamation-triangle"></i></div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Recent Orders & Jobs in a Tabbed View -->
    <div class="col-lg-8">
        <div class="card card-table h-100">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="data-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders-panel" type="button">
                            <i class="fas fa-shopping-cart me-1"></i> Recent Orders
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="jobs-tab" data-bs-toggle="tab" data-bs-target="#jobs-panel" type="button">
                            <i class="fas fa-clipboard-list me-1"></i> Recent Jobs
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body p-0">
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="orders-panel" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr><th>ID</th><th>Customer</th><th>Product</th><th>Status</th></tr>
                                </thead>
                                <tbody>
                                    {% for order in recent_orders %}
                                    <tr>
                                        <td><strong>#{{ order.OrderID }}</strong></td>
                                        <td>{{ order.CustomerName }}</td>
                                        <td>{{ order.ProductName }} ({{ order.Quantity }})</td>
                                        <td><span class="badge bg-{% if order.Status == 'Confirmed' %}warning{% elif order.Status == 'Delivered' %}success{% else %}secondary{% endif %}">{{ order.Status }}</span></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="jobs-panel" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr><th>ID</th><th>Type</th><th>Assigned To</th><th>Status</th></tr>
                                </thead>
                                <tbody>
                                    {% for job in recent_jobs %}
                                    <tr>
                                        <td><strong>#{{ job.JobCardID }}</strong></td>
                                        <td>{{ job.JobType }}</td>
                                        <td>{{ job.AssignedTo or 'Unassigned' }}</td>
                                        <td><span class="badge bg-{% if job.Status == 'Open' %}warning{% elif job.Status == 'Completed' %}success{% elif job.Status == 'In Progress' %}primary{% else %}secondary{% endif %}">{{ job.Status }}</span></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts and Actions Column -->
    <div class="col-lg-4">
        {% if low_inventory %}
        <div class="card mb-4" style="background: linear-gradient(135deg, #ffc107, #dc3545); color: white;">
            <div class="card-body">
                <h5 class="card-title fw-bold"><i class="fas fa-exclamation-circle me-2"></i>Low Inventory Alert</h5>
                <ul class="list-group list-group-flush">
                    {% for item in low_inventory %}
                    <li class="list-group-item bg-transparent text-white d-flex justify-content-between align-items-center border-white-50 py-2">
                        {{ item.MaterialName }}
                        <span class="badge bg-light text-dark rounded-pill">{{ item.CurrentStock }} / {{ item.Threshold }} {{ item.Unit }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}
        
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-cogs me-2"></i>Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-3">
                    <button class="btn btn-primary btn-lg" onclick="autoCreateJobs()"><i class="fas fa-plus me-2"></i> Auto-Create Jobs</button>
                    <button class="btn btn-success btn-lg" onclick="syncInventory()"><i class="fas fa-sync me-2"></i> Sync Inventory</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function autoCreateJobs() {
    fetch('/api/auto_create_jobs', { method: 'POST', headers: {'Content-Type': 'application/json'} })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`${data.created_jobs} job cards created successfully!`);
            location.reload();
        } else {
            alert('Failed to create job cards');
        }
    }).catch(error => console.error('Error:', error));
}

function syncInventory() {
    fetch('/api/sync_inventory', { method: 'POST', headers: {'Content-Type': 'application/json'} })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`${data.synced_jobs} inventory records synchronized!`);
            location.reload();
        } else {
            alert('Failed to sync inventory');
        }
    }).catch(error => console.error('Error:', error));
}
</script>
{% endblock %}
