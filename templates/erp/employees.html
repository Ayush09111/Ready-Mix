{% extends "base.html" %}

{% block title %}Employees - ERP System{% endblock %}

{% block content %}
<style>
    .main-header {
        background: linear-gradient(90deg, #6f42c1 0%, #d63384 100%);
        color: white;
        padding: 2.5rem;
        border-radius: 1rem;
        margin-bottom: 2.5rem;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }
    .table thead th, .table tbody td {
        vertical-align: middle;
    }
    .search-bar {
        position: relative;
    }
    .search-bar .fa-search {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
    }
    .search-bar .form-control {
        padding-left: 2.5rem;
    }

    /* --- Custom Modal Styles --- */
    .custom-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9998;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .custom-modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }
    .custom-modal-content {
        background: white;
        border-radius: 0.5rem;
        max-width: 800px;
        width: 90%;
        z-index: 9999;
        transform: scale(0.9);
        transition: transform 0.3s ease;
        overflow: hidden;
    }
    .custom-modal-overlay.active .custom-modal-content {
        transform: scale(1);
    }
    .custom-modal-header, .custom-modal-footer {
        padding: 1rem 1.5rem;
        background-color: #f7f7f7;
    }
    .custom-modal-body {
        padding: 1.5rem;
    }
    .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
    }
    .delete-modal-content {
        max-width: 500px;
        text-align: center;
    }
</style>

<!-- Header -->
<div class="main-header">
    <h2><i class="fas fa-users me-2"></i> Employee Management</h2>
    <p class="lead mb-0">Manage employee information, roles, and departments.</p>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">All Employees</h5>
                <button class="btn btn-primary" id="add-employee-btn"><i class="fas fa-plus me-2"></i>Add New Employee</button>
            </div>
            <div class="card-body">
                <div class="mb-3 search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" id="employeeSearch" class="form-control" placeholder="Search by name, role, department, or email...">
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Role</th>
                                <th>Department</th>
                                <th>Phone</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="employeesTableBody">
                            {% for employee in employees %}
                            <tr>
                                <td><strong>{{ employee.EmployeeID }}</strong></td>
                                <td>{{ employee.Name }}</td>
                                <td>{{ employee.RoleName or 'N/A' }}</td>
                                <td>{{ employee.DepartmentName or 'N/A' }}</td>
                                <td>{{ employee.Phone }}</td>
                                <td>{{ employee.Email }}</td>
                                <td>
                                    <span class="badge bg-{% if employee.Status == 'Active' %}success{% else %}secondary{% endif %}">
                                        {{ employee.Status }}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary edit-btn"
                                            data-id="{{ employee.EmployeeID }}"
                                            data-name="{{ employee.Name }}"
                                            data-role="{{ employee.RoleID }}"
                                            data-department="{{ employee.DepartmentID }}"
                                            data-phone="{{ employee.Phone }}"
                                            data-email="{{ employee.Email }}"
                                            data-status="{{ employee.Status }}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-btn"
                                            data-id="{{ employee.EmployeeID }}"
                                            data-name="{{ employee.Name }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Employee Modal -->
<div id="employeeModal" class="custom-modal-overlay">
    <div class="custom-modal-content">
        <div class="custom-modal-header">
            <h5 class="modal-title" id="modalTitle">Add New Employee</h5>
        </div>
        <div class="custom-modal-body">
            <form id="employeeForm" method="POST" action="{{ url_for('erp_employees') }}">
                <input type="hidden" id="employeeId" name="employeeId">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="name" class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="email" class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="phone" class="form-label">Phone Number</label>
                        <input type="text" class="form-control" id="phone" name="phone">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status" name="status" required>
                            <option>Active</option>
                            <option>Inactive</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="roleId" class="form-label">Role</label>
                        <select class="form-select" id="roleId" name="roleId" required>
                            {% for role in roles %}
                            <option value="{{ role.RoleID }}">{{ role.RoleName }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="departmentId" class="form-label">Department</label>
                        <select class="form-select" id="departmentId" name="departmentId" required>
                            {% for department in departments %}
                            <option value="{{ department.DepartmentID }}">{{ department.DepartmentName }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </form>
        </div>
        <div class="custom-modal-footer">
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" id="cancelEmployeeBtn">Close</button>
                <button type="submit" form="employeeForm" class="btn btn-primary">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="custom-modal-overlay">
    <div class="custom-modal-content delete-modal-content">
        <h5 class="modal-title">Confirm Deletion</h5>
        <hr>
        <p id="deleteModalText" class="my-4"></p>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" id="cancelDeleteBtn">Cancel</button>
            <form id="deleteForm" method="POST">
                <button type="submit" class="btn btn-danger">Delete Employee</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Add/Edit Employee Modal Logic ---
    const employeeModal = document.getElementById('employeeModal');
    const modalTitle = document.getElementById('modalTitle');
    const employeeForm = document.getElementById('employeeForm');
    const employeeIdInput = document.getElementById('employeeId');
    const cancelEmployeeBtn = document.getElementById('cancelEmployeeBtn');

    function showEmployeeModal() { employeeModal.classList.add('active'); }
    function hideEmployeeModal() { employeeModal.classList.remove('active'); }

    document.getElementById('add-employee-btn').addEventListener('click', function() {
        modalTitle.textContent = 'Add New Employee';
        employeeForm.reset();
        employeeIdInput.value = '';
        showEmployeeModal();
    });

    document.querySelectorAll('.edit-btn').forEach(button => {
        button.addEventListener('click', function() {
            modalTitle.textContent = 'Edit Employee';
            employeeIdInput.value = this.dataset.id;
            document.getElementById('name').value = this.dataset.name;
            document.getElementById('email').value = this.dataset.email;
            document.getElementById('phone').value = this.dataset.phone;
            document.getElementById('status').value = this.dataset.status;
            document.getElementById('roleId').value = this.dataset.role;
            document.getElementById('departmentId').value = this.dataset.department;
            showEmployeeModal();
        });
    });

    cancelEmployeeBtn.addEventListener('click', hideEmployeeModal);
    employeeModal.addEventListener('click', function(e) { if(e.target === this) hideEmployeeModal(); });

    // --- Delete Confirmation Modal Logic ---
    const deleteModal = document.getElementById('deleteModal');
    const deleteModalText = document.getElementById('deleteModalText');
    const deleteForm = document.getElementById('deleteForm');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');

    function showDeleteModal() { deleteModal.classList.add('active'); }
    function hideDeleteModal() { deleteModal.classList.remove('active'); }

    document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', function() {
            const employeeId = this.dataset.id;
            const employeeName = this.dataset.name;
            deleteModalText.innerHTML = `Are you sure you want to delete <strong>${employeeName}</strong>? This will also remove their user account. This action cannot be undone.`;
            deleteForm.action = `/erp/employees/delete/${employeeId}`;
            showDeleteModal();
        });
    });

    cancelDeleteBtn.addEventListener('click', hideDeleteModal);
    deleteModal.addEventListener('click', function(e) { if(e.target === this) hideDeleteModal(); });

    // --- Live Search Functionality ---
    const searchInput = document.getElementById('employeeSearch');
    const tableBody = document.getElementById('employeesTableBody');
    const tableRows = tableBody.getElementsByTagName('tr');

    searchInput.addEventListener('keyup', function() {
        const filter = searchInput.value.toLowerCase();
        for (let row of tableRows) {
            if (row.textContent.toLowerCase().includes(filter)) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        }
    });
});
</script>
{% endblock %}
