{% extends "base.html" %}

{% block title %}Vehicles - ERP System{% endblock %}

{% block content %}
<style>
    .main-header {
        background: linear-gradient(90deg, #fd7e14 0%, #ffc107 100%);
        color: white;
        padding: 2.5rem;
        border-radius: 1rem;
        margin-bottom: 2.5rem;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }
    .table thead th {
        vertical-align: middle;
    }
    .table tbody td {
        vertical-align: middle;
    }

    /* --- Custom Modal Styles --- */
    .custom-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9998;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .custom-modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }
    .custom-modal-content {
        background: white;
        border-radius: 0.5rem;
        max-width: 800px;
        width: 90%;
        z-index: 9999;
        transform: scale(0.9);
        transition: transform 0.3s ease;
        overflow: hidden;
    }
    .custom-modal-overlay.active .custom-modal-content {
        transform: scale(1);
    }
    .custom-modal-header, .custom-modal-footer {
        padding: 1rem 1.5rem;
        background-color: #f7f7f7;
    }
    .custom-modal-body {
        padding: 1.5rem;
    }
    .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
    }
    .delete-modal-content {
        max-width: 500px;
        text-align: center;
    }
</style>

<!-- Header -->
<div class="main-header">
    <h2><i class="fas fa-truck me-2"></i> Fleet Management</h2>
    <p class="lead mb-0">Manage vehicles, maintenance, and dispatch schedules.</p>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">All Vehicles</h5>
                <button class="btn btn-primary" id="add-vehicle-btn"><i class="fas fa-plus me-2"></i>Add New Vehicle</button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Vehicle Name</th>
                                <th>Registration No</th>
                                <th>Type</th>
                                <th>Capacity</th>
                                <th>Status</th>
                                <th>Current Job</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for vehicle in vehicles %}
                            <tr>
                                <td><strong>{{ vehicle.VehicleID }}</strong></td>
                                <td>{{ vehicle.VehicleName }}</td>
                                <td>{{ vehicle.RegistrationNo }}</td>
                                <td>{{ vehicle.Type }}</td>
                                <td>{{ vehicle.Capacity }}</td>
                                <td>
                                    <span class="badge bg-{% if vehicle.Status == 'Available' %}success{% elif vehicle.Status == 'In Use' %}primary{% else %}warning text-dark{% endif %}">
                                        {{ vehicle.Status }}
                                    </span>
                                </td>
                                <td>
                                    {% if vehicle.JobCardID %}
                                        <a href="{{ url_for('jobkart_job_detail', job_id=vehicle.JobCardID) }}" class="badge bg-info text-decoration-none">Job #{{ vehicle.JobCardID }}</a>
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary edit-btn" 
                                            data-id="{{ vehicle.VehicleID }}"
                                            data-name="{{ vehicle.VehicleName }}"
                                            data-reg="{{ vehicle.RegistrationNo }}"
                                            data-type="{{ vehicle.Type }}"
                                            data-status="{{ vehicle.Status }}"
                                            data-capacity="{{ vehicle.Capacity }}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-btn"
                                            data-id="{{ vehicle.VehicleID }}"
                                            data-name="{{ vehicle.VehicleName }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Vehicle Modal -->
<div id="vehicleModal" class="custom-modal-overlay">
    <div class="custom-modal-content">
        <div class="custom-modal-header">
            <h5 class="modal-title" id="modalTitle">Add New Vehicle</h5>
        </div>
        <div class="custom-modal-body">
            <form id="vehicleForm" method="POST" action="{{ url_for('erp_vehicles') }}">
                <input type="hidden" id="vehicleId" name="vehicleId">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="vehicleName" class="form-label">Vehicle Name</label>
                        <input type="text" class="form-control" id="vehicleName" name="vehicleName" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="registrationNo" class="form-label">Registration No</label>
                        <input type="text" class="form-control" id="registrationNo" name="registrationNo" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="type" class="form-label">Type</label>
                        <input type="text" class="form-control" id="type" name="type" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="capacity" class="form-label">Capacity</label>
                        <input type="text" class="form-control" id="capacity" name="capacity">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status" name="status" required>
                            <option>Available</option>
                            <option>In Use</option>
                            <option>Under Maintenance</option>
                        </select>
                    </div>
                </div>
            </form>
        </div>
        <div class="custom-modal-footer">
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" id="cancelVehicleBtn">Close</button>
                <button type="submit" form="vehicleForm" class="btn btn-primary">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="custom-modal-overlay">
    <div class="custom-modal-content delete-modal-content">
        <h5 class="modal-title">Confirm Deletion</h5>
        <hr>
        <p id="deleteModalText" class="my-4"></p>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" id="cancelDeleteBtn">Cancel</button>
            <form id="deleteForm" method="POST">
                <button type="submit" class="btn btn-danger">Delete Vehicle</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Add/Edit Vehicle Modal Logic ---
    const vehicleModal = document.getElementById('vehicleModal');
    const modalTitle = document.getElementById('modalTitle');
    const vehicleForm = document.getElementById('vehicleForm');
    const vehicleIdInput = document.getElementById('vehicleId');
    const cancelVehicleBtn = document.getElementById('cancelVehicleBtn');

    function showVehicleModal() { vehicleModal.classList.add('active'); }
    function hideVehicleModal() { vehicleModal.classList.remove('active'); }

    document.getElementById('add-vehicle-btn').addEventListener('click', function() {
        modalTitle.textContent = 'Add New Vehicle';
        vehicleForm.reset();
        vehicleIdInput.value = '';
        showVehicleModal();
    });

    document.querySelectorAll('.edit-btn').forEach(button => {
        button.addEventListener('click', function() {
            modalTitle.textContent = 'Edit Vehicle';
            vehicleIdInput.value = this.dataset.id;
            document.getElementById('vehicleName').value = this.dataset.name;
            document.getElementById('registrationNo').value = this.dataset.reg;
            document.getElementById('type').value = this.dataset.type;
            document.getElementById('status').value = this.dataset.status;
            document.getElementById('capacity').value = this.dataset.capacity;
            showVehicleModal();
        });
    });

    cancelVehicleBtn.addEventListener('click', hideVehicleModal);
    vehicleModal.addEventListener('click', function(e) { if(e.target === this) hideVehicleModal(); });

    // --- Delete Confirmation Modal Logic ---
    const deleteModal = document.getElementById('deleteModal');
    const deleteModalText = document.getElementById('deleteModalText');
    const deleteForm = document.getElementById('deleteForm');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');

    function showDeleteModal() { deleteModal.classList.add('active'); }
    function hideDeleteModal() { deleteModal.classList.remove('active'); }

    document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', function() {
            const vehicleId = this.dataset.id;
            const vehicleName = this.dataset.name;
            deleteModalText.innerHTML = `Are you sure you want to delete <strong>${vehicleName}</strong>? This action cannot be undone.`;
            deleteForm.action = `/erp/vehicles/delete/${vehicleId}`;
            showDeleteModal();
        });
    });

    cancelDeleteBtn.addEventListener('click', hideDeleteModal);
    deleteModal.addEventListener('click', function(e) { if(e.target === this) hideDeleteModal(); });
});
</script>
{% endblock %}
